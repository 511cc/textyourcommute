#!/usr/bin/env node
const async = require('async');
const debug = require('debug')('textyourcommute');
const nconf = require('nconf');
const moment = require('moment-timezone');
const argv = require('yargs').argv;
nconf
  .argv()
  .env()
  .file({file:'./config.json'});

const twilio = require('twilio');
const client = twilio(nconf.get('TWILIO_SID'), nconf.get('TWILIO_AUTH_TOKEN'));

const db = require('mongoose').connect(nconf.get('MONGOLAB_URI'));

require('../models/models').setupModels();

const IntroSurvey = db.model('survey');
const DailySurvey = db.model('daily_survey');

const questions = require('../lib/questions');

function sendSMS(to, body, cb) {
  debug(`Sending SMS to ${to}`);
  client.sendMessage({
    to: to,
    from: nconf.get('TWILIO_NUMBER'),
    body: body
  }, (e, response) => {
    if(e) {
      console.error(e);
    }
    cb();
  });
}

function sendCommuteQuestion(user, cb) {
  const date = moment().tz('America/Los_Angeles').startOf('day');
  if(argv.type === 'am') {

    const dailySurvey = new DailySurvey({
      src: user.src,
      date: date
    });
    dailySurvey.save((e) => {
      if(e) return cb(e);

      // ask if user commuted
      sendSMS(user.src, questions.daily, cb);
    });
  } else if(argv.type === 'pm') {
    DailySurvey.findOne({src: user.src, date: date}, (e, dailySurvey) => {
      if(e) return cb(e);

      if(!dailySurvey) {
        debug(`Skipping ${user.src} becasue no daily_survey found`);
        cb();
      } else if(dailySurvey.commuted && dailySurvey.amMode) {
        sendSMS(user.src, questions.dailyEvening, cb);
      } else {
        debug(`Skipping ${user.src} because commuted=${dailySurvey.commuted} amMode=${dailySurvey.amMode}`);
        cb();
      }
    });
  } else {
    cb();
  }
}

function handleError(e) {
  console.error(e.stack);
  process.exit(1);
}

function sendDailySurvey() {
  IntroSurvey.find({status: 'completed'}, (e, users) => {
    if(e) return handleError(e);

    async.each(users, sendCommuteQuestion, (e) => {
      if (e) {
        console.error(e);
      }
      debug('Complete');
      process.exit(0);
    });
  });
}


// Do survey if it is a weekday
const dayOfWeek = moment().tz('America/Los_Angeles').day();
if (dayOfWeek !== 0 && dayOfWeek !== 6) {
  sendDailySurvey();
}
